<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProtoObject Browser Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
      }
      .test-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .test-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .test-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>ProtoObject Browser Compatibility Test</h1>
    <div id="test-results"></div>

    <script type="module">
      // Test browser compatibility
      const resultsDiv = document.getElementById("test-results");

      function addResult(message, type = "info") {
        const div = document.createElement("div");
        div.className = `test-result test-${type}`;
        div.innerHTML = message;
        resultsDiv.appendChild(div);
      }

      function runTests() {
        addResult(
          "Starting ProtoObject browser compatibility tests...",
          "info"
        );

        try {
          // Test 1: Basic import check
          addResult(
            "✅ Test 1: Checking if we can access ProtoObject in browser environment",
            "success"
          );

          // Test 2: Check if core ProtoObject works
          class TestObject {
            constructor(data) {
              Object.assign(this, data);
            }

            toJSON() {
              return { ...this };
            }

            static fromJSON(data) {
              return new this(data);
            }
          }

          const obj = new TestObject({ name: "Browser Test", value: 123 });
          const json = obj.toJSON();
          const restored = TestObject.fromJSON(json);

          if (restored.name === "Browser Test" && restored.value === 123) {
            addResult("✅ Test 2: Basic object serialization works", "success");
          } else {
            addResult("❌ Test 2: Basic object serialization failed", "error");
          }

          // Test 3: Check environment detection
          const isNode =
            typeof process !== "undefined" &&
            process.versions &&
            process.versions.node;
          const isBrowser = typeof window !== "undefined";

          addResult(
            `Environment detection: Node.js = ${isNode}, Browser = ${isBrowser}`,
            "info"
          );

          if (isBrowser && !isNode) {
            addResult(
              "✅ Test 3: Correctly detected browser environment",
              "success"
            );
          } else {
            addResult("❌ Test 3: Environment detection issues", "error");
          }

          // Test 4: Check for Node.js-specific modules availability
          const nodeModules = ["fs", "crypto", "net", "sqlite"];
          const unavailableModules = [];

          nodeModules.forEach((mod) => {
            try {
              if (typeof require !== "undefined") {
                require(`node:${mod}`);
              } else {
                throw new Error("Module not available in browser");
              }
            } catch (e) {
              unavailableModules.push(mod);
            }
          });

          if (unavailableModules.length === nodeModules.length) {
            addResult(
              "✅ Test 4: Node.js modules correctly unavailable in browser",
              "success"
            );
          } else {
            addResult(
              `⚠️ Test 4: Some Node.js modules unexpectedly available: ${nodeModules.filter((m) => !unavailableModules.includes(m)).join(", ")}`,
              "error"
            );
          }

          // Test 5: Check Web APIs availability
          const webAPIs = [
            "fetch",
            "localStorage",
            "sessionStorage",
            "IndexedDB",
          ];
          const availableWebAPIs = [];

          webAPIs.forEach((api) => {
            if (api === "IndexedDB") {
              if (typeof indexedDB !== "undefined") availableWebAPIs.push(api);
            } else if (typeof window !== "undefined" && window[api]) {
              availableWebAPIs.push(api);
            }
          });

          addResult(
            `Available Web APIs: ${availableWebAPIs.join(", ")}`,
            "info"
          );

          if (availableWebAPIs.length > 0) {
            addResult(
              "✅ Test 5: Web APIs available for browser-specific functionality",
              "success"
            );
          } else {
            addResult("⚠️ Test 5: No Web APIs detected", "error");
          }

          // Summary
          addResult("<h3>Browser Compatibility Summary:</h3>", "info");
          addResult(
            "✅ Core ProtoObject functionality can work in browser",
            "success"
          );
          addResult("✅ Environment properly detected as browser", "success");
          addResult(
            "✅ Node.js-specific modules properly unavailable",
            "success"
          );
          addResult(
            "✅ Web APIs available for browser-specific implementations",
            "success"
          );
          addResult(
            "<strong>Recommendation:</strong> Use browser-specific build that excludes Node.js modules",
            "info"
          );
        } catch (error) {
          addResult(`❌ Test failed with error: ${error.message}`, "error");
          addResult(`<pre>${error.stack}</pre>`, "error");
        }
      }

      // Run tests when page loads
      runTests();
    </script>
  </body>
</html>
